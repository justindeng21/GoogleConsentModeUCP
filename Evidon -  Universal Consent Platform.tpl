___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "Evidon -  Universal Consent Platform",
  "brand": {
    "id": "github.com_EvidonCMP",
    "displayName": "EvidonCMP",
    "thumbnail": "data:image/png;base64,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\u003d\u003d"
  },
  "description": "Universal Consent Platform is a CMP provided by Crownpeak. Data is collected for personalization and analytic purposes. For more information please visit: https://business.safety.google/privacy.",
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "CHECKBOX",
    "name": "enableUrlPassthrough",
    "checkboxText": "Enables URL passthrough",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "enableDebugMode",
    "checkboxText": "Enabled Debug Mode",
    "simpleValueType": true
  },
  {
    "type": "CHECKBOX",
    "name": "disableAdvancedMode",
    "checkboxText": "Disable Advanced Mode",
    "simpleValueType": true
  },
  {
    "type": "TEXT",
    "name": "companyId",
    "displayName": "CompanyID",
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "POSITIVE_NUMBER",
        "errorMessage": "The Company Id must be a positive integer."
      },
      {
        "type": "NON_EMPTY",
        "errorMessage": "The Company Id cannot be undefined."
      }
    ],
    "valueHint": "Company ID (Required)"
  },
  {
    "type": "SELECT",
    "name": "adStorage",
    "displayName": "Ad Storage",
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "Denied"
      },
      {
        "value": "granted",
        "displayValue": "Granted"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "analyticsStorage",
    "displayName": "Analytics Storage",
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "Denied"
      },
      {
        "value": "granted",
        "displayValue": "Granted"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "adPersonalization",
    "displayName": "Ad Personalization",
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "Denied"
      },
      {
        "value": "granted",
        "displayValue": "Granted"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "adUserData",
    "displayName": "Ad User Data",
    "selectItems": [
      {
        "value": "denied",
        "displayValue": "Denied"
      },
      {
        "value": "granted",
        "displayValue": "Granted"
      }
    ],
    "simpleValueType": true,
    "valueValidators": [
      {
        "type": "NON_EMPTY"
      }
    ],
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentGlobally",
    "checkboxText": "Global Consent",
    "simpleValueType": true,
    "displayName": "Enables default consent Globally",
    "help": "Enables default Google consent state globally.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentNorthAmerica",
    "checkboxText": "North America",
    "simpleValueType": true,
    "displayName": "Enables default consent for North America",
    "help": "Enables default Google consent state for the following regions: US, CA, PM, MQ.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentEurope",
    "checkboxText": "Europe",
    "simpleValueType": true,
    "displayName": "Enable default consent for Europe",
    "help": "Enables default Google consent state for the following regions: DE, ES, FR, GB, IT, NL, DK, IE, PL, AT, BE, SE, SK, HU, FI, PT, CZ, LU, GR, BG, RO, EE, LV, LT, SI, MT, CY, HR, IM, JE, GI, BY.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentAsiaPacific",
    "checkboxText": "Asia Pacific",
    "simpleValueType": true,
    "displayName": "Enables default consent for Asia Pacific",
    "help": "Enables default Google consent state for the following regions: CN, TW, KR, JP, AU, NZ, ID, MY, TH, IN, SG, HK, VN, AM, PH, LA, KH, NP, LK, MM, BN.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentMiddleEast",
    "checkboxText": "Middle East",
    "simpleValueType": true,
    "displayName": "Enables default consent for Middle East",
    "help": "Enables default Google consent state for the following regions: IL, TR, EG, SA, LY, AE.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentEuropeNonEU",
    "checkboxText": "Europe - Non EU",
    "simpleValueType": true,
    "displayName": "Enables default consent for Europe - Non EU",
    "help": "Enables default Google consent state for the following regions: RU, NO, CH, IS, MK, RS, UA, AL, BA, MD, GE, LI.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentSouthAmerica",
    "checkboxText": "South America",
    "simpleValueType": true,
    "displayName": "Enables default consent for South America",
    "help": "Enables default Google consent state for the following regions: BR, AR, BO, CL, CO, EC, GY, PY, PE, SR, UY, VE, GF.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentOtherEU",
    "checkboxText": "Other EU",
    "simpleValueType": true,
    "displayName": "Enables default consent for Other EU",
    "help": "Enables default Google consent state for the following regions: RE, GG, PF, WF, YT.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentAfrica",
    "checkboxText": "Africa",
    "simpleValueType": true,
    "displayName": "Enables default consent for Africa",
    "help": "Enables default Google consent state for the following regions: ZA, DZ, NG, CG, CD, GA, MA, SN, TN, MU.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentCaribbean",
    "checkboxText": "Caribbean",
    "simpleValueType": true,
    "displayName": "Enables default consent for Caribbean",
    "help": "Enables default Google consent state for the following regions: AI, AG, AW, BS, BB, BM, VG, KY, DM, DO, GD, HT, JM, AN, PR, KN, LC, VC, TT, TC, VI, GP, BL, MF.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "CHECKBOX",
    "name": "defaultConsentCentralAmerica",
    "checkboxText": "Central America",
    "simpleValueType": true,
    "displayName": "Enables default consent for Central America",
    "help": "Enables default Google consent state for the following regions: MX, BZ, CR, SV, GT, HN, NI, PA.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SIMPLE_TABLE",
    "name": "userDefinedRegions",
    "displayName": "",
    "simpleTableColumns": [
      {
        "defaultValue": "",
        "displayName": "Custom Regions",
        "name": "region",
        "type": "TEXT",
        "valueValidators": [
          {
            "type": "STRING_LENGTH",
            "args": [
              2,
              5
            ]
          }
        ],
        "valueHint": "Please enter a valid ISO 3166-1 or ISO 3166-2 country code",
        "isUnique": true
      }
    ],
    "help": "Enables default Google consent state for you own custom set of regions.",
    "enablingConditions": [
      {
        "paramName": "disableAdvancedMode",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

/* --- Imports --- */
const log = require('logToConsole');
const injectScript = require('injectScript');
const setInWindow = require('setInWindow');
const getUrl = require('getUrl');
const makeInteger = require('makeInteger');
const setDefaultConsentState = require('setDefaultConsentState');
const gtagSet = require('gtagSet');
const updateConsentState = require('updateConsentState');
const copyFromWindow = require("copyFromWindow");
const companyId = data.companyId;
const domain = getRootDomain();
const callLater = require("callLater");
const evidonSiteNoticeTag = "https://c.evidon.com/gtm/evidon-sitenotice-tag.js";
const country = "https://c.evidon.com/geo/country.js";
const snThemes = "https://c.evidon.com/sitenotice/" + companyId + "/snthemes.js";
const settingsV3 = "https://c.evidon.com/sitenotice/" + companyId + "/" + domain + "/settingsV3.js";
const debug = "https://c.evidon.com/gtm/debug.js";

const supportedRegions = {
    northAmerica: ['US', 'CA', 'PM', 'MQ'],
    europeEU: ['DE', 'ES', 'FR', 'GB', 'IT', 'NL', 'DK', 'IE', 'PL', 'AT', 'BE', 'SE', 'SK', 'HU', 'FI', 'PT', 'CZ', 'LU', 'GR', 'BG', 'RO', 'EE', 'LV', 'LT', 'SI', 'MT', 'CY', 'HR', 'IM', 'JE', 'GI', 'BY'],
    asiaPacific: ['CN', 'TW', 'KR', 'JP', 'AU', 'NZ', 'ID', 'MY', 'TH', 'IN', 'SG', 'HK', 'VN', 'AM', 'PH', 'LA', 'KH', 'NP', 'LK', 'MM', 'BN'],
    middleEast: ['IL', 'TR', 'EG', 'SA', 'LY', 'AE'],
    europeNonEU: ['RU', 'NO', 'CH', 'IS', 'MK', 'RS', 'UA', 'AL', 'BA', 'MD', 'GE', 'LI'],
    southAmerica: ['BR', 'AR', 'BO', 'CL', 'CO', 'EC', 'GY', 'PY', 'PE', 'SR', 'UY', 'VE', 'GF'],
    otherEU: ['RE', 'GG', 'PF', 'WF', 'YT'],
    africa: ['ZA', 'DZ', 'NG', 'CG', 'CD', 'GA', 'MA', 'SN', 'TN', 'MU'],
    caribbean: ['AI', 'AG', 'AW', 'BS', 'BB', 'BM', 'VG', 'KY', 'DM', 'DO', 'GD', 'HT', 'JM', 'AN', 'PR', 'KN', 'LC', 'VC', 'TT', 'TC', 'VI', 'GP', 'BL', 'MF'],
    centralAmerica: ['MX', 'BZ', 'CR', 'SV', 'GT', 'HN', 'NI', 'PA']
};

function getRegions() {
    var regions = [];

    if (data.defaultConsentNorthAmerica)
        regions = regions.concat(supportedRegions.northAmerica);

    if (data.defaultConsentEurope)
        regions = regions.concat(supportedRegions.europeEU);

    if (data.defaultConsentAsiaPacific)
        regions = regions.concat(supportedRegions.asiaPacific);

    if (data.defaultConsentMiddleEast)
        regions = regions.concat(supportedRegions.middleEast);

    if (data.defaultConsentEuropeNonEU)
        regions = regions.concat(supportedRegions.europeNonEU);

    if (data.defaultConsentSouthAmerica)
        regions = regions.concat(supportedRegions.southAmerica);

    if (data.defaultConsentOtherEU)
        regions = regions.concat(supportedRegions.otherEU);

    if (data.defaultConsentAfrica)
        regions = regions.concat(supportedRegions.africa);

    if (data.defaultConsentCaribbean)
        regions = regions.concat(supportedRegions.caribbean);

    if (data.defaultConsentCentralAmerica)
        regions = regions.concat(supportedRegions.centralAmerica);

    if (data.userDefinedRegions !== undefined) {
        for (var i = 0; i <= data.userDefinedRegions.length - 1; i++) {
            regions = regions.concat([data.userDefinedRegions[i].region.toUpperCase()]);
        }
    }

    return regions;
}

function is2parttld(value) {
    var tldindicators = ['co', 'com', 'info', 'web', 'info', 'gov', 'edu', 'biz', 'net', 'org'];
    var countryindicators = ['uk', 'us', 'fr', 'es', 'de', 'at', 'au', 'ae', 'be', 'br', 'ca', 'ch', 'cn', 'co', 'cz', 'dk', 'eg', 'eu', 'fi', 'gb', 'gr', 'hk', 'hr', 'hu', 'ie', 'in', 'jp', 'mx', 'nl', 'no', 'nz', 'pl', 'ro', 'ru', 'se'];
    return (tldindicators.indexOf(value) !== -1 || countryindicators.indexOf(value) !== -1);
}

function getRootDomain() {
    var parts;
    var rootDomain = '';
    parts = getUrl('host').split('.');
    if (parts.length === 2)
        rootDomain = parts[0];

    else if (parts.length > 2) {
        var part = parts[parts.length - 2];
        if (is2parttld(part)) {
            rootDomain = parts[parts.length - 3];
        }
        else {
            rootDomain = part;
        }
    }
    return rootDomain;
}



function setDefaultConsent() {
    gtagSet({ 'ads_data_redaction': true, 'developer_id': 'dOGRkZj' });

    if (data.enableUrlPassthrough) {
        gtagSet({ 'url_passthrough': true });
    }
    else {
        gtagSet({ 'url_passthrough': false });
    }

  
    if(!data.disableAdvancedMode){
        !data.disableAdvancedMode
        var defaultConsentState = {
            'ad_storage': data.adStorage,
            'analytics_storage': data.analyticsStorage,
            'ad_user_data': data.adUserData,
            'ad_personalization': data.adPersonalization
        };

        if(regions.length !== 0 && data.defaultConsentGlobally){ 
            defaultConsentState.region = regions;
        }
  
        setDefaultConsentState(defaultConsentState);
    }
  
    else{
      log("Advanced Mode Disabled");
    }

    return;
}


const updateGoogleConsent = (evidonConsentState) => {
  
    
    if(!data.disableAdvancedMode){
        if(data.adStorage == "granted") evidonConsentState.ad_storage = "granted";
        if(data.analyticsStorage == "granted") evidonConsentState.analytics_storage = "granted";
        if(data.adUserData == "granted") evidonConsentState.ad_user_data = "granted";
        if(data.adPersonalization == "granted") evidonConsentState.ad_personalization = "granted";
        updateConsentState(evidonConsentState);
    }
    if(data.enableDebugMode) copyFromWindow("evidon.logConsentUpdate")();
};


function injectDebugScript() {
    injectScript(debug, onSucessDebug, onFailureDebug, "Debug Mode");
}

function defineUpdateMethod() {
    setInWindow('evidon.updateGoogleConsent', updateGoogleConsent);
    return;
}

function defineEvidonObject() {
    const companyId = data.companyId;
    setInWindow('evidon', [], true);
    setInWindow('evidon.id', makeInteger(companyId), true);
    setInWindow('evidon.test', false, true);
    setInWindow('evidon.googleTemplateEnabled', true, true);
    defineUpdateMethod();
}


function injectEvidonScripts() {
    injectScript(evidonSiteNoticeTag, onSuccessEvidonSiteNoticeTag, onFailureEvidonSiteNoticeTag, "Evidon evidon-sitenotice-tag");
    injectScript(country, onSuccessCountry, onFailureCountry, "Evidon country");
    injectScript(snThemes, onSuccessSnThemes, onFailureSnThemes, "Evidon snThemes");
    injectScript(settingsV3, onSuccessSettingsV3, onFailureSettingsV3, "Evidon settingsV3");
    if(data.enableDebugMode) injectDebugScript();
}

/* --- Define Error and Sucess Callbacks --- */
const onSuccessEvidonSiteNoticeTag = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tevidon-sitenotice-tag.js loading sucessful","color: #0C0");
};
const onFailureEvidonSiteNoticeTag = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tevidon-sitenotice-tag.js loading failed","color: #C00");
};
const onSuccessCountry = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tcountry.js loading sucessful","color: #0C0");
};
const onFailureCountry = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tcountry.js loading failed","color: #C00");
};
const onSuccessSnThemes = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tsnthemes.js loading sucessful","color: #0C0");
};
const onFailureSnThemes = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tsnthemes.js loading failed","color: #C00");
};
const onSuccessSettingsV3 = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tsettingsV3.js loading sucessful","color: #0C0");
};
const onFailureSettingsV3 = () => {
    //if(data.enableDebugMode) log("%c"+"\n\tsettingsV3.js loading failed","color: #C00");
};
const onSucessDebug = () => {
    copyFromWindow("evidon.checkConsentTiming")();
    copyFromWindow("evidon.logConsent")();
};

const onFailureDebug = () =>{};


setDefaultConsent();
defineEvidonObject();
injectEvidonScripts();


data.gtmOnSuccess();


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "all"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://c.evidon.com/*"
              },
              {
                "type": 1,
                "string": "https://dg-sandbox-deb249716852.herokuapp.com/*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.id"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.test"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.updateGoogleConsent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.logConsentUpdate"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.logConsent"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.checkConsentTiming"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "evidon.googleTemplateEnabled"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "gtag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "get_url",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urlParts",
          "value": {
            "type": 1,
            "string": "specific"
          }
        },
        {
          "key": "host",
          "value": {
            "type": 8,
            "boolean": true
          }
        },
        {
          "key": "queriesAllowed",
          "value": {
            "type": 1,
            "string": "any"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "access_consent",
        "versionId": "1"
      },
      "param": [
        {
          "key": "consentTypes",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "analytics_storage"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_user_data"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "ad_personalization"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              },
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "consentType"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "regions"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "write_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ads_data_redaction"
              },
              {
                "type": 1,
                "string": "developer_id"
              },
              {
                "type": 1,
                "string": "url_passthrough"
              },
              {
                "type": 1,
                "string": "event"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: Quick Test
  code: runCode();
setup: ''


___NOTES___

Created on 6/7/2024, 4:45:02 PM


